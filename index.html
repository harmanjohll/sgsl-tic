<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SgSL Portal</title>

  <!-- Three.js for Text‚ÜíSign -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

  <!-- MediaPipe Hands for Sign‚ÜíText -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    #app { display: none; }
    input, button { font-size: 1rem; padding: 0.5rem; }
    #error { color: red; margin-top: 1rem; }
    section { margin-top: 2rem; border-top: 1px solid #ccc; padding-top: 1rem; }

    /* Text‚ÜíSign avatar container */
    #avatarContainer {
      width: 400px; height: 300px;
      margin: 1rem auto; border: 1px solid #666;
    }

    /* Sign‚ÜíText container: will size to video */
    #signToText {
      position: relative;
      margin: 1rem auto;
    }
    #signCanvas {
      border: 1px solid #666;
      display: block; margin: 0 auto;
    }
    /* Hide the raw video element completely */
    #signVideo { display: none; }
  </style>
</head>
<body>

  <!-- LOGIN SCREEN -->
  <div id="login">
    <h1>Sign in with your school email</h1>
    <input type="email" id="emailInput" placeholder="you@btyss.moe.edu.sg"/>
    <button id="loginBtn">Sign In</button>
    <p id="error"></p>
  </div>

  <!-- MAIN APP -->
  <div id="app">
    <h1>üëã Welcome to the SgSL Portal</h1>

    <!-- 1. Text ‚Üí Sign -->
    <section id="textToSign">
      <h2>1. Text ‚Üí Sign</h2>
      <input type="text" id="wordInput" placeholder="Type a word‚Ä¶"/>
      <button id="showSignBtn">Show Sign</button>
      <p id="lookupResult"></p>
      <div id="avatarContainer"></div>
    </section>

    <!-- 2. Sign ‚Üí Text -->
    <section id="signToText">
      <h2>2. Sign ‚Üí Text</h2>
      <p id="signResult">(initializing‚Ä¶)</p>
      <video id="signVideo" autoplay playsinline></video>
      <canvas id="signCanvas"></canvas>
    </section>

    <!-- 3. Contribute -->
    <section id="contribute">
      <h2>3. Contribute a Sign</h2>
      <p>(Upload form here.)</p>
    </section>
  </div>

  <script>
  (function(){
    // ‚Äî LOGIN ‚Äî
    const ALLOWED = '@btyss.moe.edu.sg';
    const loginDiv = document.getElementById('login');
    const appDiv   = document.getElementById('app');
    const emailIn  = document.getElementById('emailInput');
    const errorP   = document.getElementById('error');

    document.getElementById('loginBtn').onclick = () => {
      const email = emailIn.value.trim().toLowerCase();
      errorP.textContent = '';
      if (!email) {
        errorP.textContent = 'Please enter your email.';
      } else if (!email.endsWith(ALLOWED)) {
        errorP.textContent = `Only ${ALLOWED} addresses allowed.`;
      } else {
        loginDiv.style.display = 'none';
        appDiv.style.display   = 'block';
        initTextToSign();
        initSignToText();
      }
    };

    // ‚Äî Text ‚Üí Sign stub (rotating cube) ‚Äî
    let scene, camera, renderer, cube;
    function initTextToSign(){
      const container = document.getElementById('avatarContainer');
      scene    = new THREE.Scene();
      camera   = new THREE.PerspectiveCamera(75, container.clientWidth/container.clientHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer();
      renderer.setSize(container.clientWidth, container.clientHeight);
      container.appendChild(renderer.domElement);

      const geometry = new THREE.BoxGeometry();
      const material = new THREE.MeshNormalMaterial();
      cube = new THREE.Mesh(geometry, material);
      scene.add(cube);
      camera.position.z = 5;

      (function animate(){
        requestAnimationFrame(animate);
        cube.rotation.x += 0.01;
        cube.rotation.y += 0.01;
        renderer.render(scene, camera);
      })();
    }

    // ‚Äî Sign ‚Üí Text with MediaPipe Hands (supports 2 hands) ‚Äî
    async function initSignToText(){
      const video   = document.getElementById('signVideo');
      const canvas  = document.getElementById('signCanvas');
      const resultP = document.getElementById('signResult');
      const ctx     = canvas.getContext('2d');

      // 1. Start webcam
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      await new Promise(r => video.onloadedmetadata = r);

      // 2. Match canvas size to video‚Äôs actual resolution
      canvas.width  = video.videoWidth;
      canvas.height = video.videoHeight;
      // Also constrain styling if you wish:
      canvas.style.width  = video.videoWidth + 'px';
      canvas.style.height = video.videoHeight + 'px';

      // 3. Load MediaPipe Hands
      resultP.textContent = 'Loading detector‚Ä¶';
      const hands = new Hands({
        locateFile: (file) => 
          `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
      });
      hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
      });
      hands.onResults(onHandsResults);

      // 4. Run camera frames into detector
      const cameraFeed = new Camera(video, {
        onFrame: async () => { await hands.send({ image: video }); },
        width: video.videoWidth,
        height: video.videoHeight
      });
      cameraFeed.start();

      // 5. Draw results
      function onHandsResults(results) {
        // draw the video frame
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        ctx.lineWidth   = 2;
        ctx.strokeStyle = 'red';
        ctx.fillStyle   = 'red';

        const handsList = results.multiHandLandmarks || [];
        if (handsList.length) {
          resultP.textContent = `Detected ${handsList.length} hand(s)`;
          for (const landmarks of handsList) {
            // draw connections
            drawConnectors(ctx, landmarks, HAND_CONNECTIONS, { color:'red', lineWidth:2 });
            // draw landmarks
            drawLandmarks(ctx, landmarks, { color:'red', lineWidth:1 });
          }
        } else {
          resultP.textContent = 'No hands detected';
        }
      }
    }

    // ‚Äî Text‚ÜíSign lookup stub ‚Äî
    document.getElementById('showSignBtn').onclick = () => {
      const word = document.getElementById('wordInput').value.trim();
      document.getElementById('lookupResult').textContent =
        word ? `(Stub) Would show sign for ‚Äú${word}‚Äù.` : 'Please type a word first.';
    };
  })();
  </script>
</body>
</html>
