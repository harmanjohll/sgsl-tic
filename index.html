<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SgSL Portal</title>

  <!-- Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2rem;
      margin: 0;
    }
    .section {
      max-width: 450px;
      margin: 2rem auto;
      padding-top: 1rem;
      border-top: 1px solid #ccc;
    }
    input, button {
      font-size: 1rem;
      padding: 0.5rem;
    }
    #error {
      color: red;
      margin-top: 0.5rem;
    }

    /* Textâ†’Sign */
    #textToSign #avatarContainer {
      width: 400px;
      height: 300px;
      margin: 1rem auto;
      border: 1px solid #666;
    }

    /* Signâ†’Text */
    #signToText {
      position: relative;
      width: 400px;
      margin: 1rem auto;
    }
    #signCanvas {
      border: 1px solid #666;
      display: block;
    }
    /* hide raw video */
    #signVideo { display: none; }

    /* Contribute (login + form) */
    #contribute > .subsection {
      margin-top: 1rem;
      text-align: left;
    }
    #contribute label,
    #contribute input,
    #contribute button {
      display: block;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>

  <h1>ðŸ‘‹ Welcome to the SgSL Portal</h1>

  <!-- 1. Text â†’ Sign -->
  <section id="textToSign" class="section">
    <h2>1. Text â†’ Sign</h2>
    <input type="text" id="wordInput" placeholder="Type a wordâ€¦"/>
    <button id="showSignBtn">Show Sign</button>
    <p id="lookupResult"></p>
    <div id="avatarContainer"></div>
  </section>

  <!-- 2. Sign â†’ Text -->
  <section id="signToText" class="section">
    <h2>2. Sign â†’ Text</h2>
    <p id="signResult">(initializingâ€¦)</p>
    <video id="signVideo" autoplay playsinline></video>
    <canvas id="signCanvas"></canvas>
  </section>

  <!-- 3. Contribute (gated) -->
  <section id="contribute" class="section">
    <h2>3. Contribute a Sign</h2>

    <!-- login prompt -->
    <div id="contribLogin" class="subsection">
      <label for="emailInput">Enter your school email:</label>
      <input type="email" id="emailInput" placeholder="you@btyss.moe.edu.sg"/>
      <button id="loginBtn">Sign In</button>
      <p id="error"></p>
    </div>

    <!-- upload form (hidden until login) -->
    <div id="uploadForm" class="subsection" style="display:none;">
      <label for="labelInput">Sign label (word/phrase):</label>
      <input type="text" id="labelInput" placeholder="e.g. hello"/>
      <label for="videoInput">Upload MP4 video:</label>
      <input type="file" id="videoInput" accept="video/mp4"/>
      <button id="uploadBtn">Upload Sign</button>
      <p id="uploadStatus"></p>
    </div>
  </section>

  <script>
  (function(){
    // â€” Textâ†’Sign cube stub â€”
    let scene, camera, renderer, cube;
    function initTextToSign(){
      const container = document.getElementById('avatarContainer');
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, 400/300, 0.1, 1000);
      renderer = new THREE.WebGLRenderer();
      renderer.setSize(400,300);
      container.appendChild(renderer.domElement);

      cube = new THREE.Mesh(
        new THREE.BoxGeometry(),
        new THREE.MeshNormalMaterial()
      );
      scene.add(cube);
      camera.position.z = 5;
      (function animate(){
        requestAnimationFrame(animate);
        cube.rotation.x += 0.01;
        cube.rotation.y += 0.01;
        renderer.render(scene, camera);
      })();
    }
    document.getElementById('showSignBtn').onclick = () => {
      const w = document.getElementById('wordInput').value.trim();
      document.getElementById('lookupResult').textContent =
        w ? `(Stub) Show sign for â€œ${w}â€.` : 'Please type a word.';
    };

    // â€” Signâ†’Text overlay via MediaPipe Hands â€”
    async function initSignToText(){
      const video = document.getElementById('signVideo');
      const canvas = document.getElementById('signCanvas');
      const resultP = document.getElementById('signResult');
      const ctx = canvas.getContext('2d');

      // start webcam
      const stream = await navigator.mediaDevices.getUserMedia({video:true});
      video.srcObject = stream;
      await new Promise(r => video.onloadedmetadata = r);

      // size canvas to video
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.style.width  = video.videoWidth + 'px';
      canvas.style.height = video.videoHeight + 'px';

      // load MediaPipe
      resultP.textContent = 'Loading detectorâ€¦';
      const hands = new Hands({
        locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
      });
      hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
      });
      hands.onResults(drawHands);

      // camera feed
      const cam = new Camera(video, {
        onFrame: async ()=> await hands.send({image:video}),
        width: video.videoWidth, height: video.videoHeight
      });
      cam.start();

      function drawHands(results){
        // draw video
        ctx.drawImage(video, 0,0,canvas.width,canvas.height);
        ctx.lineWidth = 2; ctx.strokeStyle='red'; ctx.fillStyle='red';

        const list = results.multiHandLandmarks || [];
        resultP.textContent = list.length
          ? `Detected ${list.length} hand(s)`
          : 'No hands detected';

        for (const lm of list){
          drawConnectors(ctx, lm, HAND_CONNECTIONS, {color:'red'});
          drawLandmarks(ctx, lm, {color:'red'});
        }
      }
    }

    // initialize modules 1 & 2 immediately
    initTextToSign();
    initSignToText();

    // â€” Contribute gating logic â€”
    const ALLOWED = '@btyss.moe.edu.sg';
    const loginDiv = document.getElementById('contribLogin');
    const formDiv  = document.getElementById('uploadForm');
    const emailIn  = document.getElementById('emailInput');
    const errorP   = document.getElementById('error');
    const loginBtn = document.getElementById('loginBtn');

    loginBtn.onclick = () => {
      const e = emailIn.value.trim().toLowerCase();
      errorP.textContent = '';
      if (!e) {
        errorP.textContent = 'Enter your email.';
      } else if (!e.endsWith(ALLOWED)) {
        errorP.textContent = `Only ${ALLOWED} allowed.`;
      } else {
        loginDiv.style.display = 'none';
        formDiv.style.display  = 'block';
      }
    };

    // stub upload handler
    document.getElementById('uploadBtn').onclick = () => {
      const lbl = document.getElementById('labelInput').value.trim();
      const vid = document.getElementById('videoInput').files[0];
      const status = document.getElementById('uploadStatus');
      if (!lbl || !vid) {
        status.textContent = 'Provide label & MP4.';
      } else {
        status.textContent = 'Uploaded! (stub)';
      }
    };
  })();
  </script>
</body>
</html>
